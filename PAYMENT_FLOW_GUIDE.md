# Gu√≠a Completa de Flujo de Pagos - Sistema POS Nephi\n\n## Descripci√≥n General\n\nEste documento detalla el nuevo sistema unificado de pagos que soporta:\n- **Adelanto (ADELANTO)**: Pago inicial sobre el total del comprobante\n- **Pago Parcial (PAGO_PARCIAL)**: Pago de parte del saldo pendiente\n- **Pago Total (PAGO_TOTAL)**: Pago total del saldo pendiente\n\nSoporta para:\n- **Notas de Pedido (NP)** - ComprobantesInformales\n- **√ìrdenes de Trabajo (OT)** - OrdenesDeTrabajoPage\n\n---\n\n## Arquitectura\n\n### Componentes Principales\n\n#### 1. **usePaymentFlow** Hook\n- Ubicaci√≥n: `src/hooks/usePaymentFlow.ts`\n- Responsabilidad: Orquestar toda la l√≥gica de flujos de pago\n- M√©todos clave:\n  - `initiatePayment(type, comprobante, saldoActual)`: Inicia un flujo de pago\n  - `validatePayment(payment, saldoPendiente, mtoImpVenta)`: Valida montos\n  - `processPayment(payment, comprobante, callback)`: Procesa el pago\n  - `reset()`: Limpia el estado\n\n#### 2. **ModalPaymentUnified**\n- Ubicaci√≥n: `src/components/ModalPaymentUnified.tsx`\n- Responsabilidad: Modal unificado para todos los tipos de pago\n- Caracter√≠sticas:\n  - Se adapta seg√∫n el tipo de pago (ADELANTO, PAGO_PARCIAL, PAGO_TOTAL)\n  - Validaci√≥n en tiempo real\n  - Selecci√≥n de medio de pago\n  - C√°lculo de vuelto (para pagos en efectivo)\n\n#### 3. **PaymentReceipt**\n- Ubicaci√≥n: `src/components/PaymentReceipt.tsx`\n- Responsabilidad: Mostrar y imprimir recibo de pago\n- Caracter√≠sticas:\n  - Adaptable a tipo de pago (recibo personalizado seg√∫n tipo)\n  - Impresi√≥n en formato ticket (80mm)\n  - Modal de confirmaci√≥n\n\n---\n\n## Flujos de Uso\n\n### Caso 1: Nota de Pedido con Adelanto\n\n**Escenario**: Cliente realiza compra por S/ 1,000 pero solo adelanta S/ 300\n\n**Pasos**:\n1. Usuario abre **ComprobantesInformales**\n2. Busca la NP correspondiente\n3. Hace clic en icono de **Moneda (üí∞)** - \"Registrar Adelanto\"\n4. Se abre `ModalPaymentUnified` con tipo \"ADELANTO\"\n5. Usuario ingresa S/ 300 (m√°ximo: S/ 1,000)\n6. Selecciona medio de pago (Efectivo, Yape, etc.)\n7. Confirma pago\n8. Backend registra pago y recalcula estado\n9. Se muestra `PaymentReceipt` con:\n   - Total Comprobante: S/ 1,000\n   - Adelanto: S/ 300\n   - **Nuevo Saldo a Pagar: S/ 700**\n   - Opci√≥n para imprimir recibo\n\n**Estado final**:\n- `estadoPago`: \"PAGO_PARCIAL\" (porque a√∫n hay saldo)\n- `saldo`: 700\n- `adelanto`: 300 (guardado en BD)\n\n---\n\n### Caso 2: Nota de Pedido con Pago Parcial\n\n**Escenario**: NP con saldo de S/ 700 (despu√©s de adelanto), cliente paga S/ 500\n\n**Pasos**:\n1. Usuario en **ComprobantesInformales**\n2. Hace clic en icono de **Dinero (üíµ)** - \"Pago Parcial\"\n3. Se abre `ModalPaymentUnified` con tipo \"PAGO_PARCIAL\"\n4. Muestra:\n   - Saldo Anterior: S/ 700\n   - Monto sugerido: S/ 700 (puede cambiar)\n5. Usuario ingresa S/ 500\n6. Se calcula vuelto si paga m√°s\n7. Selecciona medio de pago\n8. Confirma pago\n9. Se muestra `PaymentReceipt` con:\n   - Saldo Anterior: S/ 700\n   - Pago: S/ 500\n   - **Nuevo Saldo Pendiente: S/ 200**\n\n**Estado final**:\n- `estadoPago`: \"PAGO_PARCIAL\"\n- `saldo`: 200\n\n---\n\n### Caso 3: Nota de Pedido con Pago Total\n\n**Escenario**: NP con saldo de S/ 200, cliente realiza pago final\n\n**Pasos**:\n1. Usuario en **ComprobantesInformales**\n2. Hace clic en icono de **Checkmark (‚úì)** - \"Pago Total\"\n3. Se abre `ModalPaymentUnified` con tipo \"PAGO_TOTAL\"\n4. El monto es exacto: S/ 200 (no editable, o valida igualdad exacta)\n5. Selecciona medio de pago\n6. Confirma pago\n7. Se muestra `PaymentReceipt` con:\n   - Saldo Anterior: S/ 200\n   - Pago: S/ 200\n   - **Nuevo Saldo: S/ 0 (PAGADO)**\n\n**Estado final**:\n- `estadoPago`: \"COMPLETADO\"\n- `saldo`: 0\n\n---\n\n### Caso 4: Orden de Trabajo con Flujo Completo\n\n**Escenario**: OT por S/ 2,000 con adelanto, luego pagos parciales\n\n**Pasos OT Adelanto**:\n1. Usuario abre **OrdenesDeTrabajoPage**\n2. Busca OT\n3. Hace clic en **Moneda** - Adelanto\n4. Ingresa S/ 500 de adelanto\n5. Pago procesado ‚Üí Recibo ‚Üí Nuevo saldo: S/ 1,500\n\n**Pasos OT Pago Parcial**:\n1. OT con saldo de S/ 1,500\n2. Hace clic en **Dinero** - Pago Parcial\n3. Ingresa S/ 800\n4. Pago procesado ‚Üí Recibo ‚Üí Nuevo saldo: S/ 700\n\n**Pasos OT Pago Total**:\n1. OT con saldo de S/ 700\n2. Hace clic en **Checkmark** - Pago Total\n3. Pago de S/ 700\n4. Pago procesado ‚Üí Recibo ‚Üí Nuevo saldo: S/ 0\n5. OT marcada como \"COMPLETADO\"\n\n---\n\n## Validaciones Implementadas\n\n### En `usePaymentFlow.validatePayment()`\n\n```typescript\n// ADELANTO\nif (payment.monto > mtoImpVenta) \n  ‚Üí \"El adelanto no puede exceder el total\"\n\n// PAGO_PARCIAL\nif (payment.monto > saldoPendiente) \n  ‚Üí \"El pago no puede exceder el saldo pendiente\"\n\n// PAGO_TOTAL\nif (Math.abs(payment.monto - saldoPendiente) > 0.01) \n  ‚Üí \"El monto debe ser igual al saldo pendiente\"\n\n// Todas\nif (payment.monto <= 0) \n  ‚Üí \"El monto debe ser mayor a 0\"\n```\n\n---\n\n## Medios de Pago Soportados\n\n```typescript\ntype PaymentMethod = 'Efectivo' | 'Yape' | 'Plin' | 'Transferencia' | 'Tarjeta' | 'Otro'\n```\n\nCada uno con icono diferente en el modal:\n- **Efectivo**: üí∞\n- **Yape**: üì±\n- **Plin**: üì±\n- **Transferencia**: üè¶\n- **Tarjeta**: üí≥\n- **Otro**: üîÑ\n\n---\n\n## Flujo de Datos (Backend)\n\n### Endpoint: `POST /api/comprobantes/:id/pago`\n\n**Request**:\n```json\n{\n  \"monto\": 300,\n  \"medioPago\": \"Efectivo\"\n}\n```\n\n**Response**:\n```json\n{\n  \"success\": true,\n  \"id\": \"PAG-2024-001\",\n  \"comprobante\": {\n    \"id\": 123,\n    \"saldo\": 700,\n    \"estadoPago\": \"PAGO_PARCIAL\",\n    \"adelanto\": 300\n  },\n  \"pago\": {\n    \"id\": \"PAG-2024-001\",\n    \"monto\": 300,\n    \"medioPago\": \"Efectivo\",\n    \"fecha\": \"2024-10-20T14:30:00Z\"\n  }\n}\n```\n\n---\n\n## Testing Checklist\n\n### ‚úÖ Nota de Pedido (NP)\n\n- [ ] **ADELANTO**: Registrar adelanto < total\n- [ ] **ADELANTO**: Validar que adelanto no exceda total\n- [ ] **ADELANTO**: Verificar que estado sea \"PAGO_PARCIAL\"\n- [ ] **ADELANTO**: Imprimir recibo de adelanto\n\n- [ ] **PAGO_PARCIAL**: Registrar pago < saldo\n- [ ] **PAGO_PARCIAL**: Validar que pago no exceda saldo\n- [ ] **PAGO_PARCIAL**: M√∫ltiples pagos parciales\n- [ ] **PAGO_PARCIAL**: Imprimir recibo de pago parcial\n\n- [ ] **PAGO_TOTAL**: Pagar exactamente el saldo final\n- [ ] **PAGO_TOTAL**: Validar que estado sea \"COMPLETADO\"\n- [ ] **PAGO_TOTAL**: Imprimir recibo de pago total\n\n- [ ] **MEDIOS DE PAGO**: Probar todos los medios\n- [ ] **VUELTO**: Calcular vuelto cuando se paga m√°s\n- [ ] **RECARGO**: Mostrar recibos con informaci√≥n correcta\n\n### ‚úÖ Orden de Trabajo (OT)\n\n- [ ] **ADELANTO**: Registrar adelanto en OT\n- [ ] **PAGO_PARCIAL**: Pago parcial en OT\n- [ ] **PAGO_TOTAL**: Pago total en OT\n- [ ] **FLUJO COMPLETO**: Adelanto ‚Üí Parcial ‚Üí Total\n\n### ‚úÖ Funcionalidades Transversales\n\n- [ ] **IMPRESI√ìN**: Recibos se imprimen en formato 80mm\n- [ ] **REFRESCO**: Tabla se recarga despu√©s de pago\n- [ ] **ESTADOS**: Estados actualizan correctamente\n- [ ] **ERROR HANDLING**: Errores se muestran al usuario\n- [ ] **LOADING**: UI muestra loading durante proceso\n\n---\n\n## Casos Edge\n\n### Caso: Pago con Vuelto\n**Escenario**: Saldo de S/ 100, cliente da S/ 200 en efectivo\n- Sistema calcula vuelto: S/ 100\n- Se muestra en modal\n- Recibo refleja vuelto\n\n### Caso: Decimal Precision\n**Escenario**: PAGO_TOTAL con saldo 123.45\n- Validaci√≥n: `Math.abs(123.45 - 123.45) > 0.01` = false ‚úì\n- Validaci√≥n: `Math.abs(123.45 - 123.46) > 0.01` = true ‚úó (Error)\n\n### Caso: M√∫ltiples Pagos Seguidos\n**Escenario**: Usuario realiza 3 pagos parciales en la misma NP\n1. Pago 1: S/ 100 ‚Üí Saldo: 900\n2. Pago 2: S/ 200 ‚Üí Saldo: 700\n3. Pago 3: S/ 700 ‚Üí Saldo: 0 (COMPLETADO)\n\n---\n\n## C√≥digo de Ejemplo - Integraci√≥n\n\n### En una p√°gina de comprobantes:\n\n```tsx\nimport { usePaymentFlow, PaymentType } from '@/hooks/usePaymentFlow';\nimport ModalPaymentUnified from '@/components/ModalPaymentUnified';\nimport PaymentReceipt from '@/components/PaymentReceipt';\n\nconst ComprobantesPage = () => {\n  const paymentFlow = usePaymentFlow();\n  const [isOpenPayment, setIsOpenPayment] = useState(false);\n  const [paymentType, setPaymentType] = useState<PaymentType>('PAGO_PARCIAL');\n  const [comprobante, setComprobante] = useState<any>(null);\n\n  // Iniciar pago\n  const handleInitiatePayment = (comprobante: any, type: PaymentType) => {\n    setComprobante(comprobante);\n    setPaymentType(type);\n    paymentFlow.initiatePayment(type, comprobante, comprobante.saldo);\n    setIsOpenPayment(true);\n  };\n\n  // Procesar pago\n  const handleConfirmPago = async (monto: number, medioPago: string) => {\n    const result = await paymentFlow.processPayment(\n      { tipo: paymentType, monto, medioPago },\n      comprobante,\n      (data, medioPago, monto) => completePay(data, medioPago, monto)\n    );\n\n    if (result.success) {\n      // Recargar datos\n      setIsOpenPayment(false);\n    }\n  };\n\n  return (\n    <>\n      {/* Modal de Pago */}\n      {isOpenPayment && (\n        <ModalPaymentUnified\n          isOpen={isOpenPayment}\n          paymentType={paymentType}\n          saldoPendiente={comprobante?.saldo}\n          totalComprobante={comprobante?.mtoImpVenta}\n          comprobanteInfo={comprobante}\n          onConfirm={handleConfirmPago}\n          onCancel={() => {\n            setIsOpenPayment(false);\n            paymentFlow.reset();\n          }}\n        />\n      )}\n\n      {/* Recibo */}\n      {paymentFlow.showReceipt && (\n        <PaymentReceipt\n          comprobante={comprobante}\n          payment={paymentFlow.payment!}\n          numeroRecibo={paymentFlow.receiptData.numeroRecibo}\n          nuevoSaldo={paymentFlow.receiptData.nuevoSaldo}\n          company={auth}\n          onClose={() => paymentFlow.reset()}\n        />\n      )}\n    </>\n  );\n};\n```\n\n---\n\n## Troubleshooting\n\n### Problema: El modal no se abre\n**Soluci√≥n**: Verificar que `isOpenPayment` state est√° en true y el componente se renderiza condicionalmente\n\n### Problema: Validaci√≥n no funciona\n**Soluci√≥n**: Revisar `validatePayment` en `usePaymentFlow.ts` y sus l√≥gicas de comparaci√≥n\n\n### Problema: Recibo no imprime\n**Soluci√≥n**: Verificar que `react-to-print` est√° instalado y `useReactToPrint` est√° correctamente configurado\n\n### Problema: Estados no actualizan\n**Soluci√≥n**: Asegurar que `getAllInvoices` se ejecuta despu√©s del pago exitoso\n\n---\n\n## Pr√≥ximas Mejoras\n\n1. **Descuentos**: Aplicar descuentos antes del pago\n2. **Referencia de Pago**: Guardar n√∫mero de transferencia/referencia\n3. **Historial**: Panel con historial de pagos por comprobante\n4. **Reportes**: Reporte de adelantos, pagos parciales, pagos totales\n5. **Devoluciones**: Manejo de devoluciones parciales\n\n---\n\n**√öltima actualizaci√≥n**: 2024-10-20\n**Versi√≥n**: 1.0.0\n